# 浏览器回流与重绘

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

## 页面渲染

浏览器拿到代码到渲染页面，主要流程

- 解析 HTML 节点，创建 DOM 树
- 解析 CSS 创建 CSSOM 树
- 合并 CSSOM 与 DOM 为 renderTree
  - 由 DOM 树 Root 节点开始计算几点可视与样式
  - 合并的 renderTree 忽略不可视元素 (meta, script, link 等节点及 display:none 的节点)
  - 将 CSSOM 树规则赋到相应的 DOM 节点合成 renderTree 节点
- Reflow(回流)，计算出 renderTree 每个节点的大小和位置
- Repaint(渲染) renderTree 到页面上

## Repaint

如下情况一般不会影响页面布局，故只会引起重绘，不会回流
visibility 变化
backgroud 变化

## Reflow

回流会重新计算当前节点的位置与大小，同时其祖先与后代节点以及兄弟节点都会回流。
多数回流本质都会造成页面重新渲染。

### 回流触发

- 窗口调整
- 字体变更
- 增删样式文件
- 内容变更（例如用户输入）
- 伪类激活
- 操作节点 class 属性
- 操作 dom
- 计算 offsetWidth 等
- 操作节点 style 属性

### 回流优化

回流优化从 CSS 与 JS 两个大方向入手。

#### CSS

- class 变更选用更底层节点
  选用样式变更的节点来替换或变更类属性而不是在其包裹或祖先节点上。
- 避免设置内联 style
  多个内联样式中，任何单一的样式修改都会导致回流，
  将内联样式统一封装到一个 class 中，只会回流一次。
- 将动画应用于文档流外的节点
  可能的话，将动画添加到 absolute 或 fixed 定位的节点上。
- 避免表达式属性
  类似于 calc 的 css 属性设置方法会在其他节点或回流触发时进行重新计算，从而使得对应节点也触发回流。

## 总结

回流一定会引起重绘，重绘不一定回流。
一般来说，引起位置变化的都会回流并重绘，不引起位置变化的重绘即可。

Type |
